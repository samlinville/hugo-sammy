<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
        <title>Install Code Server on Ubuntu 20.04 with Tailscale | Sam Linville ‚Äî Product manager &amp; designer</title>

        
        
        <link rel="stylesheet" href="https://samlinville.com/scss/main.min.5d6800bf0b0eb90d795206ef3445d6c489cfbf7112904a77d10eea3bb9e4d852.css">
    </head>
<body>
    <div class="sammy-banner">
        <div class="sammy-container">
            <p><span class="emoji">üôãüèª‚Äç‚ôÇÔ∏è</span>&nbsp;I'm building this site out in the open, so thanks for bearing with my progress! <a href="https://samlinville.com//blog/note-on-perfection">Learn why ‚Üí</a></p>
        </div>
    </div>
    <div class="sammy-container">
        <div class="sammy-navigation">
            <div class="sammy-title">
                <p><a href="https://samlinville.com/">Sam Linville&nbsp;<span>‚Äî&nbsp;Product manager &amp; designer</span></a></p>
            </div>
            <nav>
                <ul>
                    
                    <li><a href="/about/">
                        
                        About
                    </a></li>
                    
                    <li><a href="/blog/">
                        
                        Blog
                    </a></li>
                    
                </ul>
            </nav>
        </div>



<main>
    <article>
        <header>
            <h1>Install Code Server on Ubuntu 20.04 with Tailscale</h1>
            <p>Code from anywhere, on any device</p>
        </header>
        <p>I wanted the ability to access my development environment from any device, particularly my iPad Pro. To that end, I decided to host an instance of Visual Studio Code on my home &ldquo;server&rdquo; (a computer running Proxmox). Because this dev environment has SSH key access to my Github account and interfaces with various other services, I very explicitly didn&rsquo;t want to expose it directly to the open internet.</p>
<p>As a result, I decided to integrate it into my Tailscale network. Tailscale is a Wireguard-based service that creates a private network for all of your devices, and it has truly changed my life recently, and I highly recommend it to everyone with more than one device that connects to the internet. Best of all, the free tier is <em>incredibly</em> generous to home users like me.</p>
<p><a href="https://tailscale.com/">Tailscale</a></p>
<h2 id="prerequisites">Prerequisites</h2>
<ol>
<li>
<p>Tailscale is installed and set up on the host machine and any machine you plan to use to access the VS Code instance. I&rsquo;m using the latest LTS version of Ubuntu, 20.04.</p>
<p><a href="https://tailscale.com/kb/1039/install-ubuntu-2004">Setting up Tailscale on Ubuntu 20.04 LTS (focal)</a></p>
</li>
<li>
<p>Nginx installed and configured (follow steps 1-4 for this particular setup).</p>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-20-04">How To Install Nginx on Ubuntu 20.04 | DigitalOcean</a></p>
</li>
<li>
<p>You have a non-root user with sudo access, and you should set up key-based SSH access to the host machine. Lastly, disable the ability to authenticate with a password or log in as root. You should also only allow users to SSH into the machine from certain IPs. Set this up as strict as you like, just make sure you don&rsquo;t lock yourself out. üòâ</p>
</li>
</ol>
<h2 id="installation">Installation</h2>
<p><strong>These instructions are derived from a great article over at DigitalOcean.</strong> Because we&rsquo;re installing within a Tailscale network, the process of getting a Let&rsquo;s Encrypt certificate is a little bit trickier.</p>
<p>You need to set code-server up with a real domain name that you actually own, because you&rsquo;ll be adding a TXT record to verify your ownership of the domain with Let&rsquo;s Encrypt.</p>
<h3 id="main-instructions">Main instructions</h3>
<p>Following these instructions exactly, but <strong>stop after step 2</strong>. We&rsquo;ll secure the domain ourselves.</p>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-the-code-server-cloud-ide-platform-on-ubuntu-20-04">How To Set Up the code-server Cloud IDE Platform on Ubuntu 20.04 | DigitalOcean</a></p>
<p>Note that you <em>can</em> use a domain through a public-facing DNS, but I prefer to use a DNS within my Tailscale network. I installed Pihole on a tiny VM, added it to Tailscale, and got a simple internal DNS along with a DNS-level adblocking tool. Two birds with one stone!</p>
<p>If you decide to use a public-facing DNS, you can still expect a reasonable degree of security, since anyone who attempts to connect from outside your Tailscale network will be denied.</p>
<p>To test that you set everything up successfully, visit <a href="http://yourdomain.com">http://yourdomain.com</a>. Don&rsquo;t use HTTPS yet, we haven&rsquo;t configured that. You should see a login screen for VS Code, and after you log in with the password, you should see a working instance of VS Code! You will probably notice that there&rsquo;s an alert letting you know that some features are disabled over HTTP.</p>
<p>Next, we&rsquo;ll get HTTPS set up so you have full functionality.</p>
<h3 id="securing-your-domain">Securing your domain</h3>
<p>Because Let&rsquo;s Encrypt can&rsquo;t communicate with machines inside our Tailscale network, we can&rsquo;t have a signed cert as automagically as is possible on a public-facing machine. Instead, we&rsquo;ll use DNS verification to prove to Let&rsquo;s Encrypt that we really own the domain. <strong>This works even if you&rsquo;re using an internal DNS within the Tailscale network to actually resolve the domain name.</strong></p>
<p>Make sure you have access to the DNS control panel for the domain. You&rsquo;ll need to add a TXT record as part of the certification process.</p>
<h4 id="update-firewall-settings">Update firewall settings</h4>
<p>First up, we want to modify the <code>ufw</code> rules to allow HTTPS traffic.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo ufw allow https
</code></pre></div><p>The output should look like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Rule added
Rule added <span style="color:#f92672">(</span>v6<span style="color:#f92672">)</span>
</code></pre></div><p>You need to reload <code>ufw</code> since we&rsquo;ve changed some configurations.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo ufw reload
</code></pre></div><p>If it reloads successfully, the output will be <code>Firewall reloaded</code>.</p>
<h4 id="install-certbot">Install Certbot</h4>
<p>Next, let&rsquo;s get Certbot installed. First, we need to add some repositories.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt install software-properties-common
sudo add-apt-repository universe
sudo add-apt-repository ppa:certbot/certbot
sudo apt update
</code></pre></div><p>Install Certbot and the accompanying tool for Nginx.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt install certbot python-certbot-nginx
</code></pre></div><h4 id="obtaining-a-lets-encrypt-signed-certificate">Obtaining a Let&rsquo;s Encrypt signed certificate</h4>
<p>Now for the good part‚Äì let&rsquo;s get that certificate! Here&rsquo;s what&rsquo;s going on in the command below.</p>
<ul>
<li>With <code>-d [yourdomain.com](http://yourdomain.com)</code>, we&rsquo;re specifying the domain we want to establish a certificate for.</li>
<li>The <code>--manual</code> flag means that we&rsquo;ll be doing certain parts of the configuration by hand, including adding a TXT record to our DNS.</li>
<li><code>--preferred-challenges dns</code> specifies that we&rsquo;d like for Certbot to give us a TXT record to add to our domain to verify our ownership, instead of using HTTP. Remember, we can&rsquo;t verify usng HTTP because the Let&rsquo;s Encrypt server has no ability to talk to our machine via its Tailscale IP address. This is a good thing, even though it does make our work a little more complex.</li>
<li><code>certonly</code> is another modifier that specifies we simply want to generate the certification, without any other work being done by Certbot. There is a way to use a DigitalOcean plugin to automatically add that TXT record, but for the sake of education, I chose to follow the full process manually.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">certbot -d yourdomain.com --manual --preferred-challenges dns certonly
</code></pre></div><p>Follow the prompt instructions‚Äì You&rsquo;ll likely be asked for your email address, if you agree to the T&amp;C&rsquo;s, if you want to be added to the EFF&rsquo;s mailing list, etc..</p>
<p>Finally, you&rsquo;ll see the instructions below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Please deploy a DNS TXT record under the name
_acme-challenge.yourdomain.com with the following value:

667drNmQL3vX6bu8YZlgy0wKNBlCny8yrjF1lSaUndc

Once this is deployed,
Press ENTER to <span style="color:#66d9ef">continue</span>
</code></pre></div><p>Head over to your DNS control panel, and under the domain name you specified in the config files for code-server, create the TXT record. You can use <a href="https://mxtoolbox.com/TXTLookup.aspx">MXToolbox&rsquo;s TXT Lookup tool</a> to confirm that the record has been successfully added. When it&rsquo;s been added, go back to the CLI and press Enter.</p>
<p>If the process is successful, you&rsquo;ll see a success message that lists out the paths of the signed certificate and private key. Make a note of these file paths.</p>
<h4 id="updating-nginx-settings-to-use-code-server-over-https">Updating Nginx settings to use code-server over HTTPS</h4>
<p>First, let&rsquo;s back up your old <code>code-server.conf</code> file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo cp /etc/nginx/sites-available/yourdomain.com /etc/nginx/sites-available/yourdomain.com.bak
</code></pre></div><p>Now, with your configuration safely backed up, go ahead and open up the original configuration file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo nano /etc/nginx/sites-available/yourdomain.com
</code></pre></div><p>Honestly, you can pretty much delete the entire file and just paste in the new configuration. It&rsquo;s probably faster than modifying the original, but either way, you should end up with this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">server <span style="color:#f92672">{</span>
    server_name yourdomain.com;
    location / <span style="color:#f92672">{</span>
        proxy_pass http://localhost:8080/;
        proxy_set_header Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection upgrade;
        proxy_set_header Accept-Encoding gzip;
    <span style="color:#f92672">}</span>
    listen <span style="color:#f92672">[</span>::<span style="color:#f92672">]</span>:443 ssl ipv6only<span style="color:#f92672">=</span>on; <span style="color:#75715e"># managed by Certbot</span>
    listen <span style="color:#ae81ff">443</span> ssl; <span style="color:#75715e"># managed by Certbot</span>
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem; <span style="color:#75715e"># managed by Certbot</span>
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem; <span style="color:#75715e"># managed by Certbot</span>
    include /etc/letsencrypt/options-ssl-nginx.conf; <span style="color:#75715e"># managed by Certbot</span>
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; <span style="color:#75715e"># managed by Certbot</span>
<span style="color:#f92672">}</span>

server <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>$host <span style="color:#f92672">=</span> yourdomain.com<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">301</span> https://$host$request_uri;
    <span style="color:#f92672">}</span> <span style="color:#75715e"># managed by Certbot</span>

    listen 80;
    listen <span style="color:#f92672">[</span>::<span style="color:#f92672">]</span>:80;
    server_name yourdomain.com;
    <span style="color:#66d9ef">return</span> 404; <span style="color:#75715e"># managed by Certbot</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>You should have replaced <strong>five</strong> instances of <code>[yourdomain.com](http://yourdomain.com)</code> with your own URL in the config above.</p>
<p>After this, reload Nginx</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo systemctl restart nginx
</code></pre></div><p>This should be all you need! Visit <a href="https://yourdomain.com">https://yourdomain.com</a> and if everything is configured correctly, you should be seeing a brand new, shiny instance of VS Code, viewable on any device in your Tailscale network!</p>
<h3 id="changing-the-default-user-within-code-server">Changing the default user within code-server</h3>
<p>There‚Äôs one more small detail that you‚Äôre probably going to want to tweak. By default, the systemd service that the DigitalOcean article has you establish to run code-server doesn‚Äôt specify a user, so it will probably end up running as root. Normally you might not care about this, except that VS Code will allow shell access to anyone through the web UI. If the service is running from the root account&hellip;then the VS Code terminal will be signed in as root. Obviously, whether this is protected in a Tailscale network or not, it isn‚Äôt ideal.</p>
<p>Luckily, one small tweak to the service configuration file can clear that right up.</p>
<p>Open the configuration file with</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo nano /lib/systemd/system/code-server.service
</code></pre></div><p>Add a line just below <code>[Service]</code> that reads <code>User=youruser</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
Description<span style="color:#f92672">=</span>code-server
After<span style="color:#f92672">=</span>nginx.service

<span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
User<span style="color:#f92672">=</span>youruser
Type<span style="color:#f92672">=</span>simple
Environment<span style="color:#f92672">=</span>PASSWORD<span style="color:#f92672">=</span>your_password
ExecStart<span style="color:#f92672">=</span>/usr/bin/code-server --bind-addr 127.0.0.1:8080 --user-data-dir /var/lib/code-server --auth password
Restart<span style="color:#f92672">=</span>always

<span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
WantedBy<span style="color:#f92672">=</span>multi-user.target
</code></pre></div><p>You&rsquo;ll need to completely restart the code-server service. I found that the best way to do this for this particular change is to fully <strong>stop</strong> the service, and then <strong>start</strong> it again, rather than just running a restart/reload command.</p>

    </article>
</main>



            <footer>
                <p>&#169; 2020 Sam Linville. This site follows a <a href="https://samlinville.com/code-of-ethics/">Code of Ethics.</a></p>
                <p>Made with <span class="emoji">‚ù§Ô∏è</span> in Stanford, CA</p>
            </footer>
        </div>

        <script src="/js/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script async defer src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
        <noscript><img src="https://queue.simpleanalyticscdn.com/noscript.gif" alt=""/></noscript>

    </body>
</html>